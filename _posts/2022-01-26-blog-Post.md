---
layout: post
title: Blog Post 1
---
2022-01-26

### Create database temps.db and three tables: 


```python
#first we import the packages we need
import pandas as pd
import sqlite3
from plotly import express as px
from plotly.io import write_html
conn = sqlite3.connect("temps.db") #create a database in current directory called temps.db
def prepare_df(df):
    df = df.set_index(keys=["ID", "Year"])
    df = df.stack()
    df = df.reset_index()
    df = df.rename(columns = {"level_2"  : "Month" , 0 : "Temp"})
    df["Month"] = df["Month"].str[5:].astype(int)
    df["Temp"]  = df["Temp"] / 100
    return(df)

df_iter = pd.read_csv("temps.csv", chunksize = 100000)
for df in df_iter:
    df = prepare_df(df)
    df.to_sql("temperatures", conn, if_exists = "append", index = False)

countries = pd.read_csv("countries.csv")
countries = countries.rename(columns = {"Name"  : "Country" })
countries.to_sql("countries", conn, if_exists = "replace", index = False)

stations = pd.read_csv("station-metadata.csv")
stations["FIPS 10-4"] = stations["ID"].str[0:2]
stations.to_sql("stations", conn, if_exists = "replace", index = False)

# manually copy example_fig.html to _includes directory of blog
```


### query_climate_database

```python

def (country,year_begin,year_end,month):
    cmd = \
    """
    SELECT S.NAME, S.latitude, S.longitude, C.Country,T.year,T.month,T.Temp
    FROM temperatures T
    LEFT JOIN stations S ON T.id = S.id
    LEFT JOIN countries C ON S."FIPS 10-4"= C."FIPS 10-4"
    where C.Country ='%s' and month = '%d' and year>='%d' and year<='%d'
    """%( country,month ,year_begin,year_end)
    
    df = pd.read_sql_query(cmd, conn)
    return df

conn = sqlite3.connect("temps.db") #connect temps.db
df = query_climate_database(country="India",year_begin=1980,year_end=2020,month=1)
df
```

{% include table1.html %}


### termperature_coefficient_plot

```python
from sklearn.linear_model import LinearRegression

def coef(data_group):
    x = data_group[["Year"]] # 2 brackets because X should be a df
    y = data_group["Temp"]   # 1 bracket because y should be a series
    LR = LinearRegression()
    LR.fit(x, y)
    return round(LR.coef_[0],5)
arr1={1:"January",2:"Feburary",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",10:"October",11:"November",12:"December"}

def termperature_coefficient_plot(country,year_begin,year_end,month,min_obs,**kwargs):
    df = query_climate_database(country=country,year_begin=year_begin,year_end=year_end,month=month)
    df["len"]= df.groupby(["NAME","Month"])["Temp"].transform(len) 
    climate = df[df["len"]>= min_obs]
    coefs = climate.groupby(["NAME", "Month"]).apply(coef)
    coefs = coefs.reset_index()
    climate = pd.merge(climate, coefs, on = ["NAME"]).dropna()
    climate = climate.rename(columns = {0 : "Estimated Yearly Increase(%C)"})
    
        
    fig = px.scatter_mapbox(climate, 
                        lat = "LATITUDE",
                        lon = "LONGITUDE", 
                        hover_name = "NAME", 
                        color = "Estimated Yearly Increase(%C)",
                        opacity = 0.2,
                        height = 300,
                        **kwargs
                        )
    
    s1 = "Estimates of yearly increase in temperature in {0} for statsions in {1} years {2}-{3}"
    s = s1.format(arr1[month],country,str(year_begin),str(year_end))
    fig.update_layout(title=s)
    fig.update_layout(margin={"r":0,"t":50,"l":0,"b":0})
    
    return fig
   
conn = sqlite3.connect("temps.db") #connect temps.db
#color_map=px.colors.diverging.RdGy_r #choose a colormap
color_map = px.colors.cyclical.IceFire
fig = termperature_coefficient_plot(country="India",
                                    year_begin=1980,
                                    year_end=2020,
                                    month=1,
                                    min_obs=10,
                                    zoom=2,
                                    mapbox_style="carto-positron",
                                    color_continuous_midpoint = 0,
                                    color_continuous_scale=color_map
                                  )
fig.show()
write_html(fig, "termperature_coefficient_plot.html")
conn.close()
```


{% include temperature_coefficient_plot.html %}

### LinePicture

```python
def LinePicture(country, start_year,end_year):
    '''
    This function shows multiple facets. The funnction have four
    arguments. The meaning of this function is to plot three different
    figures which can represent how temperature changed by month. 
    '''
    # connect to SQL database.
    conn = sqlite3.connect("temps.db") 
    # write our CMD to extract data.
    cmd = \
    """
    SELECT S.name, T.year, T.month, T.temp,C.Country
    FROM temperatures T
    LEFT JOIN stations S ON T.id = S.id
    LEFT JOIN countries C ON S."FIPS 10-4"= C."FIPS 10-4"
    WHERE C.Country = ? and (T.year between ? and ?)
    order by T.year
    """
    df = pd.read_sql_query(cmd, conn, params = (country, start_year,end_year))
    
    # plot our data.
    fig = px.line(data_frame = df, 
                  x = "Month", 
                  y = "Temp",
                  color = "NAME",
                  facet_col = "Year",
                  title = "Monthly Changes in Temperature in different Years and different stations in "+country 
                )
    # show the plot
    return fig

fig = LinePicture("India",2000,2003)
write_html(fig, "LinePicture.html")
fig.show()
```

{% include LinePicture.html %}

### AvgTemp

```python
from urllib.request import urlopen
import json

countries_gj_url = "https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/countries.geojson"

with urlopen(countries_gj_url) as response:
    countries_gj = json.load(response)
def AvgTemp(year,month1,month2):
    '''
    This function shows multiple facets. The funnction have three
    arguments. The meaning of this function is to plot two different
    figures which can represent how temperature changed in Juanuary and July. 
    '''
    # connect to SQL database.
    conn = sqlite3.connect("temps.db") 
    # write our CMD to extract data.
    cmd = \
    """
    SELECT C.Country,month,Avg(temp)
    FROM temperatures T
    LEFT JOIN stations S ON T.id = S.id
    LEFT JOIN countries C ON S."FIPS 10-4"= C."FIPS 10-4"
    where T.year = ? and T.month = ? or T.Month = ? 
    group by C.Country,month
    """
       
    df = pd.read_sql_query(cmd, conn,params=(year,month1,month2))
      
    fig = px.choropleth(df, 
                    geojson=countries_gj,
                    locations = "Country",
                    locationmode = "country names",
                    color = "Avg(temp)", 
                    height = 350,
                    facet_col = "Month",
                    title = "Changes in Temperature January and July of "+str(year)
                    )

    fig.update_layout(margin={"r":0,"t":50,"l":0,"b":0})
    return fig
    
fig = AvgTemp(2000,1,7)
write_html(fig, "AvgTemp.html")
fig.show()
conn.close()
```

{% include AvgTemp.html %}


end------